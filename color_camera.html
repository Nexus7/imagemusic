<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>tracking.js - color with camera</title>
    <link rel="stylesheet" href="assets/demo.css">

    <script src="tracking-min.js"></script>
    <script src="dat.gui.min.js"></script>
    <script src="assets/stats.min.js"></script>
    <script src="assets/color_camera_gui.js"></script>

    <style>
    video, canvas {
        margin-left: 100px;
        margin-top: 35px;
        position: absolute;
    }
    </style>
</head>
<body>
    <div class="demo-title">
        <p><a href="http://trackingjs.com" target="_parent">tracking.js</a> Ôºç choose the colors you want to detect through the controls on the right</p>
    </div>

    <div class="demo-frame">
        <div class="demo-container">
            <video id="video" width="600" height="450" preload autoplay loop muted controls></video>
            <canvas id="canvas" width="600" height="450"></canvas>
        </div>
    </div>

    <script>

    window.onload = function() {

        var audioContext = new AudioContext()

        var modes = [
        //	0 semi tones
        [0,1,2,3,4,5,6,7,8,9,10,11,12],
        //  1 Major
        [0,2,4,5,7,9,11,12],
        // 2 Minor (natural)
        [0,2,3,5,7,8,10,12],
        // 3 Harmonic Minor
        [0,2,3,5,7,8,11,12],
        // 4 Melodic Minor Asc
        [0,2,3,5,7,9,11,12],
        // 5 Melodic Minor Desc
        [0,2,3,5,7,8,10,12],
        // 6 Enigmatic
        [0,1,4,6,8,10,11,12],
        [0,1,3,6,8,9],
        [0,12],
        ]

        var baseFrequency = 300
        var baseMode = 4
        var arpDelay = 5
        var noteLength = 0.1

        function play(delay, pitch, duration) {
            //console.log(pitch)
            var startTime = audioContext.currentTime + delay
            var endTime = startTime + duration

            var filter = audioContext.createBiquadFilter()
            filter.connect(audioContext.destination)
            filter.type = 'highpass'
            filter.frequency.value = 500

            var oscillator = audioContext.createOscillator()
            oscillator.connect(filter)

            oscillator.type = 'sawtooth'
            oscillator.frequency.value = pitch //* 100

            oscillator.start(startTime)
            oscillator.stop(endTime)

            window.setTimeout(function() {
                isPlaying = false
                console.log('in the timeout')
            }, duration * 1000);

        }

        var getFrequency = function (requestedMode, requestedNote, octave) {
            // returns frequency
            var currentMode = modes[requestedMode]
            //currentNoteIndex = requestedNote //% currentMode.length
            octave = Math.min(1, octave);

            frequency =  baseFrequency * Math.pow(2, requestedNote / 12) * octave;

            return frequency
        };

        var playMode = function (modeIndex) {
            modes[modeIndex].forEach(function (note, index) {
                play(index/arpDelay, getFrequency(modeIndex, note, modeIndex),noteLength);
                });
        }

        var playNote = function(volume, temp, pitch, note) {
            if (!isPlaying) {
                console.log('hello there');
                play(0, getFrequency(1, Math.floor((pitch * 32) / 400), 1), 2.5)
                isPlaying = true;
            }
        }

        playMode(0);

        var video = document.getElementById('video');
        var canvas = document.getElementById('canvas');
        var context = canvas.getContext('2d');

        var tracker = new tracking.ColorTracker();

        tracking.track('#video', tracker, { camera: true });

        tracker.on('track', function(event) {
            context.clearRect(0, 0, canvas.width, canvas.height);

            event.data.forEach(function(rect) {
                if (rect.color === 'custom') {
                    rect.color = tracker.customColor;
                }

                context.strokeStyle = rect.color;
                context.strokeRect(rect.x, rect.y, rect.width, rect.height);
                context.font = '11px Helvetica';
                context.fillStyle = "#fff";
                context.fillText('x: ' + rect.x + 'px', rect.x + rect.width + 5, rect.y + 11);
                context.fillText('y: ' + rect.y + 'px', rect.x + rect.width + 5, rect.y + 22);
                console.log('rect.x: ' + rect.x + ', rect.y: ' + rect.y + ', rect.width: ' + rect.width + ', rect.height: ' + rect.height + ', rect.color: ' + rect.color);

                playNote(rect.width * rect.height, rect.x, rect.y, rect.color);

            });
        });

        initGUIControllers(tracker);
    };

    </script>

</body>
</html>
